<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paradise of Books</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .navbar {
            background: linear-gradient(45deg, #ff6f61, #ffcc29);
        }

        .navbar-brand,
        .nav-link {
            color: white;
            font-weight: 500;
        }

        .product-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .cart-count {
            background: red;
            color: white;
            border-radius: 50%;
            padding: 3px 8px;
            position: absolute;
            top: 8px;
            right: 10px;
        }
    </style>
</head>

<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand" href="#">Paradise of Books</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Bids</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Categories</a>
                    <ul class="dropdown-menu" id="categoryDropdown"></ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link position-relative" href="#">
                        Cart <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count">0</span>
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Profile</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#">Sign In</a></li>
                        <li><a class="dropdown-item" href="#">Manage Profile</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Books Section -->
<div class="container mt-4">
    <h2 class="text-center mb-4">All Sales</h2>
    <div id="booksContainer" class="row"></div>
</div>

<!-- Add to Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" class="img-fluid" style="max-height: 200px;">
                <p id="modalDescription"></p>
                <div>
                    <button class="btn btn-secondary" id="decreaseQty">-</button>
                    <span id="quantity" class="mx-2">1</span>
                    <button class="btn btn-secondary" id="increaseQty">+</button>
                </div>
                <p id="modalPrice" class="mt-2"></p>
                <button class="btn btn-primary mt-3" id="confirmAddToCart">Add to Cart</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let books = [];
    let selectedBook = {};
    let cartCount = 0;
    let currentUserId = localStorage.getItem("userId") || 1;
    let categories = [];

    // Fetch active books
    function fetchBooks() {
        $.ajax({
            url: 'http://localhost:8080/api/v1/books/ACTIVE', // Replace with the actual endpoint to get active books
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('authToken') // Use token for authorization
            },
            success: function (data) {
                console.log('Fetched books:', data);
                books = data;  // Store fetched books globally
                fetchCategories(); // Fetch categories after fetching books
                displayBooks();    // Display books after categories are fetched
            },
            error: function (xhr, status, error) {
                console.error('Error fetching books:', error);
            }
        });
    }

    function fetchCategories() {
        $.ajax({
            url: 'http://localhost:8080/api/v1/category/list', // Replace with your API endpoint for categories
            method: 'GET',
            success: function (response) {
                console.log('Fetched categories:', response);
                if (response.data && Array.isArray(response.data)) {
                    categories = response.data;  // Store the categories globally
                    populateCategoryDropdown(categories);  // Populate the category dropdown
                } else {
                    console.error("Categories are not in the expected format:", response);
                }
            },
            error: function (xhr, status, error) {
                console.error('Error fetching categories:', error);
            }
        });
    }

    // Populate category dropdown in navbar
    function populateCategoryDropdown(categories) {
        if (Array.isArray(categories)) {
            const categoryDropdown = $('#categoryDropdown');
            categoryDropdown.empty(); // Clear existing categories

            categories.forEach(category => {
                categoryDropdown.append(`
                <li><a class="dropdown-item" href="#" data-category="${category.id}" onclick="fetchBooksByCategory(${category.id})">${category.name}</a></li>
            `);
            });
        } else {
            console.error("Expected categories to be an array:", categories);
        }
    }

    // Function to get category name based on categoryId
    function getCategoryNameById(categoryId) {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: `http://localhost:8080/api/v1/category/${categoryId}`, // Replace with your API endpoint to fetch category by id
                method: 'GET',
                success: function (data) {
                    if (data && data.name) {
                        resolve(data.name);  // Resolve with the category name
                    } else {
                        resolve('Unknown Category');  // Return 'Unknown Category' if not found
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching category by id:', error);
                    resolve('Unknown Category');  // Return 'Unknown Category' in case of an error
                }
            });
        });
    }


    // Function to display books, including fetching category names
    function displayBooks() {
        let booksContainer = $('#booksContainer');
        booksContainer.empty(); // Clear previous books

        if (books.length > 0) {
            let booksByCategory = {};

            // Group books by category
            books.forEach(book => {
                if (!booksByCategory[book.categoryId]) {
                    booksByCategory[book.categoryId] = {
                        categoryName: '',  // We will fetch the category name later
                        books: []
                    };
                }
                booksByCategory[book.categoryId].books.push(book);
            });

            // Loop over categories and books, fetch category name if not already available
            Object.keys(booksByCategory).forEach(categoryId => {
                const category = booksByCategory[categoryId];

                // Fetch category name if not already available
                getCategoryNameById(categoryId).then(categoryName => {
                    category.categoryName = categoryName;  // Store the fetched category name

                    // Now display the books with the correct category name
                    booksContainer.append(`
                    <h3 class="mt-5">${category.categoryName}</h3>
                    <div class="row">
                `);

                    // Display books in this category
                    category.books.forEach(book => {
                        const imageFilename = book.image ? book.image.split("\\").pop() : "default.jpg";
                        booksContainer.append(`
                        <div class="col-md-4">
                            <div class="card product-card">
                                <img src="http://localhost:8080/uploads/images/${imageFilename}" class="card-img-top" alt="${book.title}">
                                <div class="card-body text-center">
                                    <h5 class="card-title">${book.title}</h5>
                                    <p class="card-text">$${book.price}</p>
                                    <p class="card-text">Only ${book.qty} left</p>
                                    <button class="btn btn-primary add-to-cart" data-id="${book.bid}">Add to Cart</button>
                                </div>
                            </div>
                        </div>
                    `);
                    });

                    // End of category section
                    booksContainer.append(`</div>`);
                });
            });
        } else {
            booksContainer.append('<p>No books available.</p>');
        }
    }
    // Handle adding books to cart
    $(document).on('click', '.add-to-cart', function () {
        selectedBook = books.find(book => book.bid == $(this).data('id'));

        $('#modalTitle').text(selectedBook.title);
        $('#modalImage').attr('src', `http://localhost:8080/uploads/images/${selectedBook.image.split("\\").pop()}`);
        $('#modalDescription').text(selectedBook.description || "No description available.");
        $('#modalPrice').text(`Price: $${selectedBook.price}`);
        $('#quantity').text(1);
        $('#cartModal').modal('show');
    });

    // Increase quantity in modal
    $('#increaseQty').click(function () {
        let qty = parseInt($('#quantity').text());
        $('#quantity').text(qty + 1);
    });

    // Decrease quantity in modal
    $('#decreaseQty').click(function () {
        let qty = parseInt($('#quantity').text());
        if (qty > 1) {
            $('#quantity').text(qty - 1);
        }
    });

    // Confirm add to cart
    $('#confirmAddToCart').click(function () {
        let quantity = parseInt($('#quantity').text());
        let totalPrice = selectedBook.price * quantity;

        $.ajax({
            url: 'http://localhost:8080/api/v1/bookCart/add',
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                bookId: selectedBook.bid,
                image: selectedBook.image,
                title: selectedBook.title,
                price: selectedBook.price,
                total: totalPrice,
                userId: currentUserId,
                qty: quantity
            }),
            success: function () {
                cartCount++;
                $('.cart-count').text(cartCount);
                $('#cartModal').modal('hide');
            },
            error: function (xhr, status, error) {
                console.error('Error adding to cart:', error);
            }
        });
    });

    // Initial setup when document is ready
    $(document).ready(function () {
        fetchBooks(); // Fetch books and display them when the page loads
    });
</script>

</body>

</html>
