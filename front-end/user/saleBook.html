<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bid & Sale Options</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-image: url('images/img.png'); /* Set the path to your image */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: inherit; /* Inherit the background from the body */
            background-size: cover;
            background-color: rgba(169, 169, 169, 0.7); /* Gray color with 70% opacity for a grayish tone */
            background-position: center;
            filter: blur(10px); /* Apply blur effect */
        }

        .options-container {
            position: relative;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            margin: 50px auto;
            z-index: 1; /* Ensure content appears above the blurred background */
        }

        .btn-custom {
            background: #2575fc;
            color: white;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            background: #6a11cb;
        }

        .toggle-section {
            display: none;
            margin-top: 20px;
            padding: 10px;
            background-color: #f1f1f1;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .dropdown-menu {
            background-color: #2575fc;
            border-radius: 5px;
        }

        .dropdown-item {
            color: white;
        }

        .dropdown-item:hover {
            background-color: #6a11cb;
        }
    </style>
</head>

<body>

<!-- Main Content Container for Bid & Sale options -->
<div class="options-container">
    <!-- User ID (Retrieve from LocalStorage) -->
    <div class="mb-3">
        <label for="userId" class="form-label" style="font-family: 'cursive'; font-size: 18px;">User ID</label>
        <input type="text" class="form-control" id="userId" value="" readonly>
    </div>

    <!-- Checkboxes to choose Bid or Sale -->
    <div class="form-group">
        <label style="font-family: 'Monotype Corsiva'; font-size: 27px">I want to</label>
        <div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="bidCheckbox" style="height: 20px; width: 20px; margin-top: 7px;margin-right: 10px">
                <label class="form-check-label" for="bidCheckbox" style="font-family: 'Monotype Corsiva'; font-size: 24px">
                    Bid
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="saleCheckbox" style="height: 20px; width: 20px; margin-top: 7px;margin-right: 10px">
                <label class="form-check-label" for="saleCheckbox" style="font-family: 'Monotype Corsiva'; font-size: 24px">
                    Sale
                </label>
            </div>
        </div>
    </div>

    <!-- Toggle sections for Bid and Sale -->
    <div class="toggle-section" id="bidSection">
        <h5>Bid Section</h5>
        <form id="bidForm">
            <div class="mb-3">
                <label for="title" class="form-label">Book Title</label>
                <input type="text" class="form-control" id="title" required>
            </div>
            <div class="mb-3">
                <label for="author" class="form-label">Author</label>
                <input type="text" class="form-control" id="author" required>
            </div>
            <div class="mb-3">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category" required>
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="bookStatus" class="form-label">Book Status</label>
                <select class="form-select" id="bookStatus" required>
                    <option value="new">New</option>
                    <option value="used">Used</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="bidPrice" class="form-label">Bid Amount</label>
                <input type="number" class="form-control" id="bidPrice" required>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" rows="3" required pattern="[A-Za-z0-9\s.,!?]+"></textarea>
            </div>
            <div class="mb-3">
                <label for="imageBid" class="form-label">Upload Image</label>
                <input type="file" class="form-control" id="imageBid" accept="image/*">
            </div>
            <button type="submit" class="btn btn-custom">Place Bid</button>
        </form>
        <div id="bidResponse" class="mt-3"></div>
    </div>

    <div class="toggle-section" id="saleSection">
        <h5>Sale Section</h5>
        <form id="saleForm">
            <div class="mb-3">
                <label for="titleSale" class="form-label">Book Title</label>
                <input type="text" class="form-control" id="titleSale" required>
            </div>
            <div class="mb-3">
                <label for="authorSale" class="form-label">Author</label>
                <input type="text" class="form-control" id="authorSale" required>
            </div>
            <div class="mb-3">
                <label for="categorySale" class="form-label">Category</label>
                <select class="form-select" id="categorySale" required>
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="bookStatusSale" class="form-label">Book Status</label>
                <select class="form-select" id="bookStatusSale" required>
                    <option value="new">New</option>
                    <option value="used">Used</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="salePrice" class="form-label">Price</label>
                <input type="number" class="form-control" id="salePrice" required>
            </div>
            <div class="mb-3">
                <label for="descriptionSale" class="form-label">Description</label>
                <textarea class="form-control" id="descriptionSale" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <!-- Add this input field to the sale form to handle quantity input -->
                <label for="qtySale" class="form-label">Quantity:</label>
                <input type="number" id="qtySale" name="qtySale" min="1" required>
            </div>
            <div class="mb-3">
                <label for="publishedYearSale" class="form-label">Published Year</label>
                <input type="number" class="form-control" id="publishedYearSale" required>
            </div>
            <div class="mb-3">
                <label for="imageSale" class="form-label">Upload Image</label>
                <input type="file" class="form-control" id="imageSale" accept="image/*">
            </div>
            <button type="submit" class="btn btn-custom">List Item for Sale</button>
        </form>
        <div id="saleResponse" class="mt-3"></div>
    </div>
</div>

<!-- Bootstrap JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

<!-- jQuery for AJAX calls -->
<script src="../js/jquery.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Include SweetAlert Library -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const userId = localStorage.getItem('userId');
    const token = localStorage.getItem('authToken');
    console.log(localStorage.getItem("userEmail"))

    if (userId) {
        $('#userId').val(userId);
    } else {
        $('#userId').val('Unknown User');
    }

    $(document).ready(function () {
        $('#bidCheckbox').on('change', function () {
            if ($(this).is(':checked')) {
                $('#saleCheckbox').prop('checked', false);
                $('#bidSection').show();
                $('#saleSection').hide();
            } else {
                $('#bidSection').hide();
            }
        });

        function fetchCategories() {
            $.ajax({
                url: 'http://localhost:8080/api/v1/category/list',
                method: 'GET',
                headers: { "Content-Type": "application/json" },
                success: function (data) {
                    const categories = data.data;
                    let categoryOptions = '';
                    categories.forEach(function (category) {
                        categoryOptions += `<option value="${category.cid}">${category.name}</option>`;
                    });
                    $('#category').html(categoryOptions);
                    $('#categorySale').html(categoryOptions);
                },
                error: function (err) {
                    console.error('Error fetching categories:', err);
                    Swal.fire("Error", "Failed to load categories!", "error");
                }
            });
        }

        fetchCategories();

        $('#saleCheckbox').on('change', function () {
            if ($(this).is(':checked')) {
                $('#bidCheckbox').prop('checked', false);
                $('#saleSection').show();
                $('#bidSection').hide();
            } else {
                $('#saleSection').hide();
            }
        });

        $('#bidForm').on('submit', function (e) {
            e.preventDefault();

            const description = $('#description').val();
            const descriptionPattern = /^[A-Za-z0-9\s.,!?]+$/;

            if (!descriptionPattern.test(description)) {
                Swal.fire("Validation Error", "Description contains invalid characters!", "warning");
                return;
            }

            let bidData = new FormData();
            bidData.append('userId', $('#userId').val());
            bidData.append('categoryId', $('#category').val());
            bidData.append('bidAmount', $('#bidPrice').val());
            bidData.append('description', description);
            bidData.append('author', $('#author').val());
            bidData.append('title', $('#title').val());
            bidData.append('bidDate', new Date().toISOString().slice(0, 19));
            bidData.append('status', 'closed');
            bidData.append('email', localStorage.getItem("userEmail"))

            if ($('#imageBid')[0].files[0]) {
                bidData.append('image', $('#imageBid')[0].files[0]);
            }

            $.ajax({
                url: 'http://localhost:8080/api/v1/bidding/place',
                type: 'POST',
                headers: { "Authorization": "Bearer " + token },
                data: bidData,
                processData: false,
                contentType: false,
                success: function(response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Bid Submitted Successfully!',
                        text: "Your bid is under review. We'll review it within 24 hours, and you can check its status on the 'Pending Bids' page.",
                        confirmButtonText: 'Got it!',
                        confirmButtonColor: '#3085d6'
                    });
                    $('#bidForm')[0].reset();
                }
                ,
                error: function (err) {
                    Swal.fire("Error", "Failed to place bid!", "error");
                }
            });
        });

        $('#saleForm').on('submit', function (e) {
            e.preventDefault();

            const descriptionSale = $('#descriptionSale').val();
            const descriptionSalePattern = /^[A-Za-z0-9\s.,!?]+$/;

            if (!descriptionSalePattern.test(descriptionSale)) {
                Swal.fire("Validation Error", "Description contains invalid characters!", "warning");
                return;
            }

            let formData = new FormData();
            formData.append('userId', $('#userId').val());
            formData.append('categoryId', $('#categorySale').val());
            formData.append('bookStatus', $('#bookStatusSale').val());
            formData.append('author', $('#authorSale').val());
            formData.append('title', $('#titleSale').val());
            formData.append('price', $('#salePrice').val());
            formData.append('description', descriptionSale);
            formData.append('qty', $('#qtySale').val());
            formData.append('publishedYear', $('#publishedYearSale').val());
            formData.append('activeStatus', 'DEACTIVATED');
            formData.append('email', localStorage.getItem("userEmail"))

            if ($('#imageSale')[0].files[0]) {
                formData.append('image', $('#imageSale')[0].files[0]);
            }

            $.ajax({
                url: 'http://localhost:8080/api/v1/books/place',
                type: 'POST',
                headers: { "Authorization": "Bearer " + token },
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Bid Submitted Successfully!',
                        text: "Your book is under review. We'll review it within 24 hours, and you can check its status on the 'Pending Bids' page.",
                        confirmButtonText: 'Got it!',
                        confirmButtonColor: '#3085d6'
                    });
                    $('#saleForm')[0].reset();
                },
                error: function (err) {
                    Swal.fire("Error", "Failed to list item for sale!", "error");
                }
            });
        });
    });
</script>


</body>

</html>
