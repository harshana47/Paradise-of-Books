<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Cart</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        .cart-container {
            width: 60%;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 1s ease-in-out;
        }
        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            transition: transform 0.3s ease-in-out;
        }
        .cart-item img {
            width: 50px;
            height: 50px;
            border-radius: 5px;
        }
        .btn {
            padding: 10px;
            border: none;
            cursor: pointer;
            margin: 5px;
            transition: 0.3s;
        }
        .btn-remove {
            background-color: red;
            color: white;
        }
        .btn-remove:hover {
            background-color: darkred;
        }
        .btn-checkout {
            background-color: green;
            color: white;
        }
        .btn-checkout:hover {
            background-color: darkgreen;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
<h1>Book Cart</h1>
<div class="cart-container" id="cartContainer">
    <h2>Your Books</h2>
    <div id="cartItems"></div>
    <h3>Total: $<span id="totalPrice">0.00</span></h3>
    <button class="btn btn-checkout" onclick="checkout()">Checkout</button>
    <button class="btn btn-remove" onclick="clearCart()">Clear Cart</button>
    <button class="btn" onclick="continueShopping()">Continue Shopping</button>
</div>

<script>
    let userId = localStorage.getItem("userId");
    console.log(userId)
    if (!userId) {
        console.error("User ID not found. Redirecting to login...");
        window.location.href = "../login.html";
    }
    let token = localStorage.getItem("authToken");
    if (!token) {
        console.error("Token not found. Redirecting to login...");
        window.location.href = "../login.html";
    }


    function loadCart() {
        fetch(`http://localhost:8080/api/v1/bookCart/user/${userId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => response.json())
            .then(data => {
                let cartHTML = "";
                let total = 0;
                data.forEach(item => {
                    total += item.price;

                    // Assuming item.image contains the path or filename of the image
                    const imageFilename = item.image ? item.image.split("\\").pop() : "default.jpg";
                    cartHTML += `
                <div class="cart-item" id="item-${item.bkcid}">
                    <img src="http://localhost:8080/uploads/images/${imageFilename}" alt="${item.title}">
                    <span>${item.title} - $${item.price}</span>
                    <button class="btn btn-remove" onclick="removeItem('${item.bkcid}')">Remove</button>
                </div>`;
                });
                document.getElementById("cartItems").innerHTML = cartHTML;
                document.getElementById("totalPrice").innerText = total.toFixed(2);
            })
            .catch(error => console.error("Error loading cart:", error));
    }




    function removeItem(bkcid) {
        fetch(`http://localhost:8080/api/v1/bookCart/delete/${bkcid}`, { method: 'DELETE',
            headers: { 'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token}, })
            .then(() => {
                document.getElementById(`item-${bkcid}`).style.transform = "scale(0)";
                setTimeout(loadCart, 300);
            });
    }

    function clearCart() {
        fetch(`http://localhost:8080/api/v1/bookCart/deleteAll/${userId}`, { method: 'DELETE',
            headers: { 'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token},})
            .then(() => {
                document.getElementById("cartItems").innerHTML = "";
                document.getElementById("totalPrice").innerText = "0.00";
            });
    }

    function checkout() {
        fetch(`http://localhost:8080/api/v1/bookCart/user/${userId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => {
                if (!response.ok) throw new Error("Failed to fetch cart data");
                return response.json();  // Parse the cart data as JSON
            })
            .then(data => {
                if (!data || data.length === 0) {
                    throw new Error("Cart is empty. Cannot proceed with checkout.");
                }

                let order = {
                    userId: userId,
                    totalPrice: data.reduce((sum, item) => sum + item.price, 0),
                    orderDetailsList: data.map(item => ({
                        price: item.price,
                        title: item.title
                    }))
                };

                if (!order.orderDetailsList || order.orderDetailsList.length === 0) {
                    throw new Error("Order details cannot be empty");
                }

                return fetch(`http://localhost:8080/api/v1/orders/place`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(order)
                });
            })
            .then(response => {
                if (!response.ok) throw new Error("Order placement failed");

                return response.json().catch(e => {
                    throw new Error("Received non-JSON response from server");
                });
            })
            .then(jsonResponse => {
                console.log(jsonResponse);
                clearCart();
            })
            .catch(error => {
                console.error("Error during checkout:", error);
            });
    }


    function continueShopping() {
        window.location.href = "homePage.html";
    }

    document.addEventListener("DOMContentLoaded", loadCart);
</script>
</body>
</html>
